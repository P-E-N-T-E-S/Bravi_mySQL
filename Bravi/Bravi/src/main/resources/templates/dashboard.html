<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Bravi: Dashboard</title>

    <link rel="icon" type="image/x-icon" href="/img/icon.png">
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
<div class="wrapper">
    <aside id="sidebar">
        <div class="d-flex">
            <button class="toggle-btn" type="button">
                <img src="/img/icon.png" alt="Logo Bravi">
            </button>
            <div class="sidebar-logo">
                <a href="#">Bravi</a>
            </div>
        </div>
        <ul class="sidebar-nav">
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">
                    <i class="material-symbols-outlined"> monitoring </i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link collapsed has-dropdown" data-bs-toggle="collapse"
                   data-bs-target="#entradas" aria-expanded="false" aria-controls="entradas">
                    <i class="material-symbols-outlined"> receipt_long </i>
                    <span>Entradas</span>
                </a>
                <ul id="entradas" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
                    <li class="sidebar-item">
                        <a href="/pedidos" class="sidebar-link">Pedidos</a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/fornecedores" class="sidebar-link">Fornecedores</a>
                    </li>
                </ul>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link collapsed has-dropdown" data-bs-toggle="collapse"
                   data-bs-target="#saidas" aria-expanded="false" aria-controls="saidas">
                    <i class="material-symbols-outlined"> sell </i>
                    <span>Saídas</span>
                </a>
                <ul id="saidas" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
                    <li class="sidebar-item">
                        <a href="/vendas" class="sidebar-link">Vendas</a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/clientes" class="sidebar-link">Clientes</a>
                    </li>
                </ul>
            </li>
            <li class="sidebar-item">
                <a href="#" class="sidebar-link collapsed has-dropdown" data-bs-toggle="collapse"
                   data-bs-target="#gerenciamento" aria-expanded="false" aria-controls="gerenciamento">
                    <i class="material-symbols-outlined"> inventory_2 </i>
                    <span>Gerenciamento</span>
                </a>
                <ul id="gerenciamento" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
                    <li class="sidebar-item">
                        <a href="/estoque" class="sidebar-link">Estoque</a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/produtos" class="sidebar-link">Produtos</a>
                    </li>
                    <li class="sidebar-item">
                        <a href="/categorias" class="sidebar-link">Categorias</a>
                    </li>
                </ul>
            </li>
            <li class="sidebar-item">
                <a href="/funcionarios" class="sidebar-link">
                    <i class="material-symbols-outlined"> engineering </i>
                    <span>Funcionários</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-footer">
            <a href="#" class="sidebar-link">
                <i class="material-symbols-outlined"> logout </i>
                <span>Sair</span>
            </a>
        </div>
    </aside>

    <div class="main p-3">
        <div class="text-center">
            <h1>DASHBOARD</h1>
        </div>

        <div class="row mt-4">
            <div class="col-md-4">
                <h3>Lucro</h3>
                <div id="lucro">
                </div>
            </div>
            <div class="col-md-4">
                <h3>Meta</h3>
                <div id="meta">
                </div>
            </div>
            <div class="col-md-4">
                <h3>Faturamento</h3>
                <div id="faturamento">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <canvas id="myChart1"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="myChart2"></canvas>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Maiores Compradores</h3>
                <table class="table">
                    <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Total de Compras</th>
                    </tr>
                    </thead>
                    <tbody id="maiores-compradores">
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h3>Categorias</h3>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th scope="col">Categoria</th>
                        <th scope="col">Quantidade de Produtos</th>
                    </tr>
                    </thead>
                    <tbody id="categorias-list">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    const ctx1 = document.getElementById('myChart1');
    const ctx2 = document.getElementById('myChart2');

    async function fetchLucroPorAno() {
        try {
            const response = await fetch('/dashboard/lucro-por-ano');
            if (!response.ok) throw new Error("Erro ao buscar dados.");
            const data = await response.json();

            const anos = data.anos;
            const lucros = data.lucros;

            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [{
                        label: 'Lucro por Ano (R$)',
                        data: lucros,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Lucro (R$)' }
                        },
                        x: {
                            title: { display: true, text: 'Ano' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao renderizar o gráfico:", error);
        }
    }

    async function fetchEvolucaoVendas() {
        try {
            const response = await fetch('/dashboard/evolucao-vendas');
            if (!response.ok) throw new Error("Erro ao buscar dados.");
            const data = await response.json();

            const anos = data.map(item => item.ano);
            const vendas = data.map(item => item.valor);

            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: anos,
                    datasets: [{
                        label: 'Vendas por Ano (R$)',
                        data: vendas,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Vendas (R$)' }
                        },
                        x: {
                            title: { display: true, text: 'Ano' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Erro ao renderizar o gráfico:", error);
        }
    }

    async function fetchMaioresCompradores() {
        try {
            const response = await fetch('/dashboard/maiores-compradores');
            if (!response.ok) {
                throw new Error("Erro ao buscar dados.");
            }
            const data = await response.json();

            console.log("Dados recebidos:", data);

            const compradores = Array.isArray(data) ? data : data.maiores_compradores;
            const compradoresTableBody = document.getElementById('maiores-compradores');

            compradoresTableBody.innerHTML = '';

            compradores.forEach(comprador => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${comprador.nome}</td><td>R$ ${parseFloat(comprador.total_compras).toFixed(2)}</td>`;
                compradoresTableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Erro ao buscar os maiores compradores:", error);
        }
    }

    async function fetchCategorias() {
        try {
            const response = await fetch('/dashboard/categorias');
            if (!response.ok) throw new Error("Erro ao buscar dados.");
            const categorias = await response.json();

            console.log("Dados recebidos:", categorias);

            const categoriasTableBody = document.getElementById('categorias-list');

            categoriasTableBody.innerHTML = '';

            categorias.forEach(categoria => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${categoria.nome_categoria}</td><td>${categoria.quantidade} produtos</td>`;
                categoriasTableBody.appendChild(row);
            });
        } catch (error) {
            console.error("Erro ao buscar as categorias:", error);
        }
    }


    async function fetchFaturamento() {
        try {
            const response = await fetch('/dashboard/faturamento');
            if (!response.ok) throw new Error("Erro ao buscar faturamento.");
            const data = await response.json();
            document.getElementById('faturamento').innerText = `R$ ${parseFloat(data.valor).toFixed(2)}`;
        } catch (error) {
            console.error("Erro ao buscar faturamento:", error);
        }
    }

    async function fetchMeta() {
        try {
            const response = await fetch('/dashboard/meta');
            if (!response.ok) throw new Error("Erro ao buscar meta.");
            const data = await response.json();
            document.getElementById('meta').innerText = `R$ ${parseFloat(data.meta_2023).toFixed(2)}`;
        } catch (error) {
            console.error("Erro ao buscar meta:", error);
        }
    }

    async function fetchLucro() {
        try {
            const response = await fetch('/dashboard/lucro');
            if (!response.ok) throw new Error("Erro ao buscar lucro.");
            const data = await response.json();
            document.getElementById('lucro').innerText = `R$ ${parseFloat(data.lucro).toFixed(2)}`;
        } catch (error) {
            console.error("Erro ao buscar lucro:", error);
        }
    }

    fetchFaturamento();
    fetchMeta();
    fetchLucro();
    fetchLucroPorAno();
    fetchEvolucaoVendas();
    fetchMaioresCompradores();
    fetchCategorias();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
<script src="/js/script.js"></script>
</body>

</html>
